<!DOCTYPE html>
<html lang="en">
{% set theme_name = current_user.theme if current_user.is_authenticated else request.cookies.get('theme', 'theme-light')
%}

<head>
  <!-- metas -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">


  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/' + theme_name + '.css') }}">

  <!-- <link id="themeStylesheet" rel="stylesheet" href="../static/css/theme-neondrift-old.css"> -->

  <!-- Title logic -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
  {% if title %}
  <title>PyveJournal - {{title}}</title>
  {% else %}
  <title>PyveJournal</title>
  {% endif %}
</head>

<body>
  <div id="navOverlay" class="nav-overlay d-none"></div>

  <header class="site-header">
    <nav class="navbar navbar-expand-md navbar-dark bg-steel fixed-top">
      <div class="container">

        <a class="navbar-brand me-4" href="{{ url_for('main.home') }}">PYveJournal</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarToggle"
          aria-controls="navbarToggle" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarToggle">
          <div class="d-md-flex flex-column flex-md-row justify-content-between w-100">

            <div class="navbar-nav ms-md-4">
              <a class="nav-item nav-link" href="{{ url_for('main.home') }}">Home</a>
              <a class="nav-item nav-link" href="{{ url_for('main.about') }}">About</a>
            </div>

           
            <!-- Navbar Right Side -->
            <div class="navbar-nav me-4">
              {% if current_user.is_authenticated %}
              <a class="nav-item nav-link" href="{{ url_for('posts.new_post') }}">New Post</a>
              <a class="nav-item nav-link" href="{{ url_for('users.account') }}">Account</a>
              <a class="nav-item nav-link" href="{{ url_for('users.logout') }}">Log Out</a>
              {% else %}
              <a class="nav-item nav-link" href="{{ url_for('users.login') }}">Log In</a>
              <a class="nav-item nav-link" href="{{ url_for('users.register') }}">Register</a>
              {% endif %}
              
              <!-- THEME CHOICE -->
              {% set theme_name = current_user.theme if current_user.is_authenticated else request.cookies.get('theme', 'theme-light')
              %}
              {% set display_name = theme_name.replace('theme-', '')|replace('-', ' ')|capitalize %}
              
              <div class="dropdown ms-md-2 mt-2 mt-md-0">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="themeDropdown" data-bs-toggle="dropdown"
                  aria-expanded="false">
                  {{ 'Theme: ' + display_name }}
                </button>
                <ul class="dropdown-menu" aria-labelledby="themeDropdown">
                  <li><a class="dropdown-item" href="#" onclick="setTheme('theme-light')">Light</a>
                  </li>
                  <li><a class="dropdown-item" href="#" onclick="setTheme('theme-signalforge')">SignalForge</a>
                  </li>
                  <li><a class="dropdown-item" href="#" onclick="setTheme('theme-neondrift')">Neon Drift</a>
                  </li>
                </ul>
              </div>

              
            </div>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <!-- SIDEBAR -->
  <main role="main" class="container">
    <div class="row">
      <div class="col-md-8">
        {% with messages = get_flashed_messages(with_categories = True) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
          {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
      </div>
      <aside class="col-md-4">
        <div class="content-section">
          {% if current_user.is_authenticated %}
          <h3 class="pt-2 pb-2">Hello, {{current_user.username}}!</h3>
          {% else %}
          <h3 class="pt-2 pb-2">Welcome, Guest!!</h3>
          {% endif %}
          <ul class="list-group mb-3">
            <li class="list-group-item sidebar-item list-group-item-light">Total posts sitewide: {{post_count}}</li>
            {% if current_user.is_authenticated %}
            <li class="list-group-item sidebar-item list-group-item-light">Your total posts: {{user_post_count}}</li>
            {% endif %}
            <li class="list-group-item sidebar-item list-group-item-light">News and Announcements</li>
          </ul>
        </div>
      </aside>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
    crossorigin="anonymous"></script>
</body>

</html>
<script>
  const navbar = document.getElementById('navbarToggle');
    const overlay = document.getElementById('navOverlay');

    navbar.addEventListener('show.bs.collapse', () => {
      overlay.classList.remove('d-none');
    });

    navbar.addEventListener('hide.bs.collapse', () => {
      overlay.classList.add('d-none');
    });

    // Optional: clicking the overlay collapses the navbar
    overlay.addEventListener('click', () => {
      const bsCollapse = bootstrap.Collapse.getInstance(navbar);
      bsCollapse.hide();
    });

  function setTheme(themeName) {
    fetch(`/set-theme/${themeName}`)
      .then(response => {
        if (response.status === 204) return;
        return response.json();
      })
      .then(data => {
        if (!data) return;

        // Update CSS
        const link = document.querySelector('link[href*="css/theme-"]');
        if (link) link.href = `/static/css/${themeName}.css`;

        // Update dropdown button label
        const displayName = themeName.replace('theme-', '').replace(/-/g, ' ');
        const capitalized = displayName
          .split(' ')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ');
        document.getElementById('themeDropdown').textContent = `Theme: ${capitalized}`;

        // Show flash message
        const flashContainer = document.querySelector('.col-md-8');
        const alert = document.createElement('div');
        alert.className = `alert alert-${data.category}`;
        alert.textContent = data.message;
        flashContainer.prepend(alert);
        setTimeout(() => alert.remove(), 3000);
      });
  }

</script>